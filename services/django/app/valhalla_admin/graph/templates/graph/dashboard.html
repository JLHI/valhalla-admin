{% extends "graph/layout.html" %}
{% block graph_content %}

<h2>ğŸ“Š Gestion des Graphs Valhalla</h2>

{% if docker_error %}
<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin: 20px 0;">
    <h3 style="color: #856404; margin-top: 0;">âš ï¸ Docker non accessible</h3>
    <p style="color: #856404; margin: 10px 0;">
        Le service Django ne peut pas se connecter Ã  Docker.
    </p>
    <details style="margin-top: 15px;">
        <summary style="cursor: pointer; color: #856404; font-weight: bold;">DÃ©tails de l'erreur</summary>
        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; margin-top: 10px;">{{ docker_error }}</pre>
    </details>
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
        <strong>Solutions :</strong>
        <ol style="margin: 10px 0;">
            <li>VÃ©rifier que le volume Docker est montÃ© dans docker-compose.yml :
                <pre style="background: white; padding: 8px; border-radius: 4px; margin: 5px 0;">volumes:
  - /var/run/docker.sock:/var/run/docker.sock</pre>
            </li>
            <li>RedÃ©marrer les containers :
                <pre style="background: white; padding: 8px; border-radius: 4px; margin: 5px 0;">docker-compose -f compose/docker-compose.yml restart django</pre>
            </li>
        </ol>
    </div>
</div>
{% endif %}

<!-- Stats globales -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #1976d2;">{{ stats.total_containers }}</div>
        <div style="color: #666; margin-top: 5px;">Graphs totaux</div>
    </div>
    
    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #388e3c;">{{ stats.running_containers }}</div>
        <div style="color: #666; margin-top: 5px;">Containers actifs</div>
    </div>
    
    <div style="background: #fff3e0; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #f57c00;">{{ stats.stopped_containers }}</div>
        <div style="color: #666; margin-top: 5px;">Containers arrÃªtÃ©s</div>
    </div>
    
    <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 32px; font-weight: bold; color: #7b1fa2;">{{ graphs|length }}</div>
        <div style="color: #666; margin-top: 5px;">Graphs en DB</div>
    </div>
</div>

<!-- Liste des graphs avec Ã©tat containers -->
<h3 style="margin-top: 40px;">ğŸ“¦ Ã‰tat des Containers</h3>

{% if graphs %}
<table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <thead>
        <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 12px; text-align: left;">Graph</th>
            <th style="padding: 12px; text-align: center;">Statut Build</th>
            <th style="padding: 12px; text-align: center;">Container</th>
            <th style="padding: 12px; text-align: center;">Port</th>
            <th style="padding: 12px; text-align: center;">Health</th>
            <th style="padding: 12px; text-align: center;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for graph in graphs %}
        <tr style="border-bottom: 1px solid #eee;" data-graph-id="{{ graph.id }}">
            <td style="padding: 12px;">
                <strong>{{ graph.name }}</strong><br>
                <small style="color: #666;">{{ graph.created_at|date:"d/m/Y H:i" }}</small>
                <br>
                <small style="color: #666;">
                    GTFS:
                    {% if graph.gtfs_start %}
                        {{ graph.gtfs_start|date:"d/m/Y" }} â†’ {{ graph.gtfs_end|date:"d/m/Y" }}
                    {% else %}
                        indisponible
                    {% endif %}
                </small>
            </td>
            <td style="padding: 12px; text-align: center;">
                {% if graph.status == "built" or graph.status == "serving" %}
                    <span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âœ“ PrÃªt</span>
                {% elif graph.status == "building" %}
                    <span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">ğŸ”¨ Build</span>
                {% elif graph.status == "error" %}
                    <span style="background: #f44336; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âŒ Erreur</span>
                {% else %}
                    <span style="background: #9e9e9e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">{{ graph.status }}</span>
                {% endif %}
            </td>
            <td style="padding: 12px; text-align: center;" class="container-status-{{ graph.id }}">
                {% if graph.is_serving %}
                    <span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">ğŸŸ¢ Running</span>
                {% else %}
                    <span style="background: #9e9e9e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âš« Stopped</span>
                {% endif %}
            </td>
            <td style="padding: 12px; text-align: center;" class="port-{{ graph.id }}">
                {% if graph.serve_port %}
                    <code>{{ graph.serve_port }}</code>
                {% else %}
                    <span style="color: #999;">-</span>
                {% endif %}
            </td>
            <td style="padding: 12px; text-align: center;" class="health-{{ graph.id }}">
                <span style="color: #999;">-</span>
            </td>
            <td style="padding: 12px; text-align: center;">
                {% if graph.is_ready %}
                    {% if graph.is_serving %}
                        <button class="js-stop" data-graph-id="{{ graph.id }}" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">â¹ Stop</button>
                        <button class="js-restart" data-graph-id="{{ graph.id }}" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">ğŸ”„ Restart</button>
                        <a href="http://localhost:{{ graph.serve_port }}/status" target="_blank" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 4px; text-decoration: none; display: inline-block; margin: 2px;">ğŸ”— Status</a>
                    {% else %}
                        <button class="js-start" data-graph-id="{{ graph.id }}" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">â–¶ Start</button>
                    {% endif %}
                {% else %}
                    <span style="color: #999;">Non prÃªt</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
// Fonctions de gestion containers
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

async function startContainer(taskId, btn) {
    btn.disabled = true;
    btn.textContent = 'â³ DÃ©marrage...';
    
    try {
        const response = await fetch(`/graphs/task/${taskId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Erreur: ' + data.message);
            btn.disabled = false;
            btn.textContent = 'â–¶ Start';
        }
    } catch (error) {
        alert('Erreur rÃ©seau: ' + error);
        btn.disabled = false;
        btn.textContent = 'â–¶ Start';
    }
}

async function stopContainer(taskId, btn) {
    if (!confirm('ArrÃªter ce container ?')) return;
    btn.disabled = true;
    btn.textContent = 'â³ ArrÃªt...';
    
    try {
        const response = await fetch(`/graphs/task/${taskId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Erreur: ' + data.message);
            btn.disabled = false;
            btn.textContent = 'â¹ Stop';
        }
    } catch (error) {
        alert('Erreur rÃ©seau: ' + error);
        btn.disabled = false;
        btn.textContent = 'â¹ Stop';
    }
}

async function restartContainer(taskId, btn) {
    btn.disabled = true;
    btn.textContent = 'â³ Restart...';
    
    try {
        const response = await fetch(`/graphs/task/${taskId}/restart/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Erreur: ' + data.message);
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Restart';
        }
    } catch (error) {
        alert('Erreur rÃ©seau: ' + error);
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ Restart';
    }
}

// Bind delegated click handlers to avoid inline onclick parsing issues
document.addEventListener('click', (e) => {
    const btn = e.target;
    if (btn.matches('.js-start')) {
        const id = btn.dataset.graphId;
        startContainer(id, btn);
    } else if (btn.matches('.js-stop')) {
        const id = btn.dataset.graphId;
        stopContainer(id, btn);
    } else if (btn.matches('.js-restart')) {
        const id = btn.dataset.graphId;
        restartContainer(id, btn);
    }
});

// Polling status toutes les 5 secondes
setInterval(async () => {
    const rows = document.querySelectorAll('[data-graph-id]');
    
    for (const row of rows) {
        const graphId = row.dataset.graphId;
        
        try {
            const response = await fetch(`/graphs/task/${graphId}/container-status/`);
            const data = await response.json();
            
            if (data.success && data.status) {
                const status = data.status;
                
                // Update container status
                const statusCell = row.querySelector(`.container-status-${graphId}`);
                if (status.running) {
                    statusCell.innerHTML = '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">ğŸŸ¢ Running</span>';
                } else {
                    statusCell.innerHTML = '<span style="background: #9e9e9e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âš« Stopped</span>';
                }
                
                // Update port
                const portCell = row.querySelector(`.port-${graphId}`);
                if (status.port) {
                    portCell.innerHTML = `<code>${status.port}</code>`;
                }
                
                // Update health
                const healthCell = row.querySelector(`.health-${graphId}`);
                if (status.health === 'healthy') {
                    healthCell.innerHTML = '<span style="color: #4caf50;">âœ“ Healthy</span>';
                } else if (status.health === 'unhealthy') {
                    healthCell.innerHTML = '<span style="color: #f44336;">âœ— Unhealthy</span>';
                } else {
                    healthCell.innerHTML = '<span style="color: #999;">-</span>';
                }
            }
        } catch (error) {
            console.error('Status check error:', error);
        }
    }
}, 5000);
</script>

{% else %}
<p style="text-align: center; padding: 40px; color: #999;">Aucun graph crÃ©Ã© pour le moment.</p>
{% endif %}

{% endblock %}

{% block section %}dashboard{% endblock %}