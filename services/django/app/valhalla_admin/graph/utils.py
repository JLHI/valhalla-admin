OSM_CATALOG_FR = [
    {
        "region": "Alsace",
        "file": "alsace-latest.osm.pbf",
        "size": 121,
        "url": "https://download.geofabrik.de/europe/france/alsace-latest.osm.pbf"
    },
    {
        "region": "Aquitaine",
        "file": "aquitaine-latest.osm.pbf",
        "size": 274,
        "url": "https://download.geofabrik.de/europe/france/aquitaine-latest.osm.pbf"
    },
    {
        "region": "Auvergne",
        "file": "auvergne-latest.osm.pbf",
        "size": 139,
        "url": "https://download.geofabrik.de/europe/france/auvergne-latest.osm.pbf"
    },
    {
        "region": "Basse-Normandie",
        "file": "basse-normandie-latest.osm.pbf",
        "size": 132,
        "url": "https://download.geofabrik.de/europe/france/basse-normandie-latest.osm.pbf"
    },
    {
        "region": "Bourgogne",
        "file": "bourgogne-latest.osm.pbf",
        "size": 183,
        "url": "https://download.geofabrik.de/europe/france/bourgogne-latest.osm.pbf"
    },
    {
        "region": "Bretagne",
        "file": "bretagne-latest.osm.pbf",
        "size": 305,
        "url": "https://download.geofabrik.de/europe/france/bretagne-latest.osm.pbf"
    },
    {
        "region": "Centre",
        "file": "centre-latest.osm.pbf",
        "size": 222,
        "url": "https://download.geofabrik.de/europe/france/centre-latest.osm.pbf"
    },
    {
        "region": "Champagne-Ardenne",
        "file": "champagne-ardenne-latest.osm.pbf",
        "size": 98,
        "url": "https://download.geofabrik.de/europe/france/champagne-ardenne-latest.osm.pbf"
    },
    {
        "region": "Corse",
        "file": "corse-latest.osm.pbf",
        "size": 32,
        "url": "https://download.geofabrik.de/europe/france/corse-latest.osm.pbf"
    },
    {
        "region": "Franche-Comté",
        "file": "franche-comte-latest.osm.pbf",
        "size": 114,
        "url": "https://download.geofabrik.de/europe/france/franche-comte-latest.osm.pbf"
    },
    {
        "region": "Guadeloupe",
        "file": "guadeloupe-latest.osm.pbf",
        "size": 22.4,
        "url": "https://download.geofabrik.de/europe/france/guadeloupe-latest.osm.pbf"
    },
    {
        "region": "Guyane",
        "file": "guyane-latest.osm.pbf",
        "size": 13.3,
        "url": "https://download.geofabrik.de/europe/france/guyane-latest.osm.pbf"
    },
    {
        "region": "Haute-Normandie",
        "file": "haute-normandie-latest.osm.pbf",
        "size": 98,
        "url": "https://download.geofabrik.de/europe/france/haute-normandie-latest.osm.pbf"
    },
    {
        "region": "Île-de-France",
        "file": "ile-de-france-latest.osm.pbf",
        "size": 311,
        "url": "https://download.geofabrik.de/europe/france/ile-de-france-latest.osm.pbf"
    },
    {
        "region": "Languedoc-Roussillon",
        "file": "languedoc-roussillon-latest.osm.pbf",
        "size": 246,
        "url": "https://download.geofabrik.de/europe/france/languedoc-roussillon-latest.osm.pbf"
    },
    {
        "region": "Limousin",
        "file": "limousin-latest.osm.pbf",
        "size": 92,
        "url": "https://download.geofabrik.de/europe/france/limousin-latest.osm.pbf"
    },
    {
        "region": "Lorraine",
        "file": "lorraine-latest.osm.pbf",
        "size": 158,
        "url": "https://download.geofabrik.de/europe/france/lorraine-latest.osm.pbf"
    },
    {
        "region": "Martinique",
        "file": "martinique-latest.osm.pbf",
        "size": 18.7,
        "url": "https://download.geofabrik.de/europe/france/martinique-latest.osm.pbf"
    },
    {
        "region": "Mayotte",
        "file": "mayotte-latest.osm.pbf",
        "size": 10.1,
        "url": "https://download.geofabrik.de/europe/france/mayotte-latest.osm.pbf"
    },
    {
        "region": "Midi-Pyrénées",
        "file": "midi-pyrenees-latest.osm.pbf",
        "size": 330,
        "url": "https://download.geofabrik.de/europe/france/midi-pyrenees-latest.osm.pbf"
    },
    {
        "region": "Nord-Pas-de-Calais",
        "file": "nord-pas-de-calais-latest.osm.pbf",
        "size": 220,
        "url": "https://download.geofabrik.de/europe/france/nord-pas-de-calais-latest.osm.pbf"
    },
    {
        "region": "Pays de la Loire",
        "file": "pays-de-la-loire-latest.osm.pbf",
        "size": 344,
        "url": "https://download.geofabrik.de/europe/france/pays-de-la-loire-latest.osm.pbf"
    },
    {
        "region": "Picardie",
        "file": "picardie-latest.osm.pbf",
        "size": 124,
        "url": "https://download.geofabrik.de/europe/france/picardie-latest.osm.pbf"
    },
    {
        "region": "Poitou-Charentes",
        "file": "poitou-charentes-latest.osm.pbf",
        "size": 213,
        "url": "https://download.geofabrik.de/europe/france/poitou-charentes-latest.osm.pbf"
    },
    {
        "region": "Provence-Alpes-Côte d’Azur",
        "file": "provence-alpes-cote-d-azur-latest.osm.pbf",
        "size": 358,
        "url": "https://download.geofabrik.de/europe/france/provence-alpes-cote-d-azur-latest.osm.pbf"
    },
    {
        "region": "Réunion",
        "file": "reunion-latest.osm.pbf",
        "size": 32,
        "url": "https://download.geofabrik.de/europe/france/reunion-latest.osm.pbf"
    },
    {
        "region": "Rhône-Alpes",
        "file": "rhone-alpes-latest.osm.pbf",
        "size": 484,
        "url": "https://download.geofabrik.de/europe/france/rhone-alpes-latest.osm.pbf"
    }
]

import os
import csv
from datetime import datetime, date


def _parse_yyyymmdd(value: str) -> date | None:
    """Parse a YYYYMMDD string into a date, or None if invalid."""
    try:
        return datetime.strptime(value.strip(), "%Y%m%d").date()
    except Exception:
        return None


def get_gtfs_date_range(task) -> tuple[date | None, date | None]:
    """
    Compute the overall GTFS availability date range for a BuildTask by
    inspecting its built GTFS files under output_dir/gtfs/<feed_id>/.

    Logic:
    - Prefer feed_info.txt (feed_start_date, feed_end_date) if present.
    - Else use calendar.txt (min(start_date), max(end_date)).
    - Consider calendar_dates.txt added service dates (exception_type=1)
      to extend min/max when calendar.txt is missing or narrower.

    Returns (start_date, end_date) as date objects or (None, None) if unknown.
    """
    gtfs_root = os.path.join(task.output_dir or "", "gtfs")
    if not os.path.isdir(gtfs_root):
        return (None, None)

    # list subdirectories per feed
    try:
        feeds = [d for d in os.listdir(gtfs_root) if os.path.isdir(os.path.join(gtfs_root, d))]
    except Exception:
        feeds = []

    global_start = None
    global_end = None

    for feed in feeds:
        feed_dir = os.path.join(gtfs_root, feed)

        # Try feed_info.txt
        fi_start = None
        fi_end = None
        feed_info_path = os.path.join(feed_dir, "feed_info.txt")
        if os.path.exists(feed_info_path):
            try:
                with open(feed_info_path, "r", encoding="utf-8", errors="ignore") as f:
                    reader = csv.DictReader(f)
                    for row in reader:
                        # Some feeds have multiple rows; take min/max across rows
                        s = _parse_yyyymmdd(row.get("feed_start_date", ""))
                        e = _parse_yyyymmdd(row.get("feed_end_date", ""))
                        if s and (fi_start is None or s < fi_start):
                            fi_start = s
                        if e and (fi_end is None or e > fi_end):
                            fi_end = e
            except Exception:
                pass

        # Fallback calendar.txt
        cal_start = None
        cal_end = None
        calendar_path = os.path.join(feed_dir, "calendar.txt")
        if os.path.exists(calendar_path):
            try:
                with open(calendar_path, "r", encoding="utf-8", errors="ignore") as f:
                    reader = csv.DictReader(f)
                    for row in reader:
                        s = _parse_yyyymmdd(row.get("start_date", ""))
                        e = _parse_yyyymmdd(row.get("end_date", ""))
                        if s and (cal_start is None or s < cal_start):
                            cal_start = s
                        if e and (cal_end is None or e > cal_end):
                            cal_end = e
            except Exception:
                pass

        # Consider calendar_dates added service dates
        add_min = None
        add_max = None
        cal_dates_path = os.path.join(feed_dir, "calendar_dates.txt")
        if os.path.exists(cal_dates_path):
            try:
                with open(cal_dates_path, "r", encoding="utf-8", errors="ignore") as f:
                    reader = csv.DictReader(f)
                    for row in reader:
                        # exception_type: 1 added, 2 removed
                        try:
                            exc = int(str(row.get("exception_type", "")).strip())
                        except Exception:
                            exc = None
                        if exc == 1:
                            d = _parse_yyyymmdd(row.get("date", ""))
                            if d:
                                if add_min is None or d < add_min:
                                    add_min = d
                                if add_max is None or d > add_max:
                                    add_max = d
            except Exception:
                pass

        # Choose best range for this feed
        feed_start = fi_start or cal_start or add_min
        feed_end = fi_end or cal_end or add_max

        if feed_start and (global_start is None or feed_start < global_start):
            global_start = feed_start
        if feed_end and (global_end is None or feed_end > global_end):
            global_end = feed_end

    return (global_start, global_end)
